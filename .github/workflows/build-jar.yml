name: Build JAR

on:
  push:
    branches: [ master, main ]
    paths:
      - 'src/**'
      - 'build.gradle'
      - 'gradle/**'
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:  # ExecuÃ§Ã£o manual

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # NecessÃ¡rio para anÃ¡lise de mudanÃ§as
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
        
    - name: Pull published Docker image
      run: |
        # Pull da imagem publicada
        docker pull axwayjbarros/aws-lambda-apim-sdk:1.0.0
        
    - name: Semantic Versioning
      run: |
        echo "ğŸ” Analisando mudanÃ§as para versionamento semÃ¢ntico..."
        ./scripts/version-bump.sh
        
        if [ -f .version_info ]; then
          source .version_info
          echo "ğŸ“‹ InformaÃ§Ãµes da versÃ£o:"
          echo "   Tipo: $VERSION_TYPE"
          echo "   VersÃ£o anterior: $OLD_VERSION"
          echo "   Nova versÃ£o: $NEW_VERSION"
          echo "   MudanÃ§as detectadas: $CHANGES_DETECTED"
          echo "   Ã‰ PR: $PR_DETECTED"
        else
          echo "âš ï¸  Arquivo .version_info nÃ£o encontrado"
        fi
        
    - name: Build JAR using published image
      run: |
        # Executar build do JAR usando a imagem publicada
        docker run --rm \
          -v "$(pwd):/workspace" \
          -v "$(pwd)/build:/workspace/build" \
          -v "$(pwd)/.gradle:/workspace/.gradle" \
          -w /workspace \
          axwayjbarros/aws-lambda-apim-sdk:1.0.0 \
          bash -c "
            echo 'ğŸ”§ Configurando ambiente...'
            export JAVA_HOME=/opt/java/openjdk-11
            export PATH=\$JAVA_HOME/bin:\$PATH
            
            echo 'ğŸ“¦ Verificando Java...'
            java -version
            
            echo 'ğŸ“¦ Verificando Gradle...'
            gradle --version || echo 'Gradle nÃ£o encontrado, instalando...'
            
            echo 'ğŸ”¨ Executando build...'
            gradle -Daxway.base=/opt/Axway clean build
            
            echo 'ğŸ“‹ Verificando resultado...'
            ls -la build/libs/ || echo 'DiretÃ³rio build/libs nÃ£o encontrado'
          "
        
    - name: Test JAR
      run: |
        # Verificar se o JAR foi criado
        echo "ğŸ” Verificando JAR criado..."
        ls -la build/libs/aws-lambda-apim-sdk-*.jar || echo "âŒ JAR nÃ£o encontrado"
        
        # Verificar conteÃºdo do JAR
        echo "ğŸ“‹ ConteÃºdo do JAR:"
        jar -tf build/libs/aws-lambda-apim-sdk-*.jar | head -10 || echo "âŒ NÃ£o foi possÃ­vel verificar conteÃºdo"
        
        # Verificar tamanho do JAR
        echo "ğŸ“ Tamanho do JAR:"
        du -h build/libs/aws-lambda-apim-sdk-*.jar || echo "âŒ NÃ£o foi possÃ­vel verificar tamanho"
        
        # Verificar se o JAR contÃ©m as classes principais
        echo "ğŸ” Verificando classes principais..."
        jar -tf build/libs/aws-lambda-apim-sdk-*.jar | grep -E "(AWSLambdaFilter|AWSLambdaProcessor)" || echo "âŒ Classes principais nÃ£o encontradas"
        
    - name: Upload JAR as artifact
      uses: actions/upload-artifact@v4
      with:
        name: aws-lambda-apim-sdk-jar
        path: build/libs/aws-lambda-apim-sdk-*.jar
        retention-days: 30
        
    - name: Commit version bump
      if: github.event_name != 'pull_request' && contains(github.ref, 'master')
      run: |
        if [ -f .version_info ]; then
          source .version_info
          if [ "$PR_DETECTED" = "false" ] && [ "$CHANGES_DETECTED" = "true" ]; then
            echo "ğŸš€ Commitando nova versÃ£o: $NEW_VERSION"
            
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            
            git add build.gradle
            git commit -m "chore: bump version to $NEW_VERSION [skip ci]"
            git push origin master
          else
            echo "â­ï¸  Pulando commit da versÃ£o (PR ou sem mudanÃ§as)"
          fi
        else
          echo "âš ï¸  Arquivo .version_info nÃ£o encontrado"
        fi
        
    - name: Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          try {
            const jarFiles = fs.readdirSync('build/libs').filter(file => file.endsWith('.jar'));
            const jarFile = jarFiles[0];
            const jarPath = path.join('build/libs', jarFile);
            const stats = fs.statSync(jarPath);
            const sizeInMB = (stats.size / (1024 * 1024)).toFixed(2);
            
            // Ler informaÃ§Ãµes da versÃ£o se disponÃ­vel
            let versionInfo = '';
            try {
              const fs = require('fs');
              if (fs.existsSync('.version_info')) {
                const versionData = fs.readFileSync('.version_info', 'utf8');
                const lines = versionData.split('\n');
                const versionMap = {};
                lines.forEach(line => {
                  const [key, value] = line.split('=');
                  if (key && value) versionMap[key] = value;
                });
                
                if (versionMap.VERSION_TYPE && versionMap.NEW_VERSION) {
                  versionInfo = `
                  
                  ğŸ”¢ **Versionamento SemÃ¢ntico:**
                  ğŸ“Š **Tipo:** ${versionMap.VERSION_TYPE}
                  ğŸ“ˆ **Nova versÃ£o:** ${versionMap.NEW_VERSION}
                  ğŸ“‹ **VersÃ£o anterior:** ${versionMap.OLD_VERSION}`;
                }
              }
            } catch (e) {
              console.log('NÃ£o foi possÃ­vel ler informaÃ§Ãµes da versÃ£o:', e.message);
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âœ… Build concluÃ­do com sucesso!
              
              ğŸ“¦ **JAR criado:** ${jarFile}
              ğŸ“ **Tamanho:** ${sizeInMB} MB
              ğŸ”§ **Build com:** axwayjbarros/aws-lambda-apim-sdk:1.0.0${versionInfo}
              
              O JAR estÃ¡ disponÃ­vel como artifact para download.`
            });
          } catch (error) {
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âŒ Build falhou!
              
              Erro: ${error.message}
              
              Verifique os logs para mais detalhes.`
            });
          } 