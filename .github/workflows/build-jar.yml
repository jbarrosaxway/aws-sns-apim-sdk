name: Build JAR

on:
  push:
    branches: [ master, main, develop ]
    paths:
      - 'src/**'
      - 'build.gradle'
      - 'gradle/**'
  pull_request:
    branches: [ master, main, develop ]
  workflow_dispatch:  # ExecuÃ§Ã£o manual

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: read
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # NecessÃ¡rio para anÃ¡lise de mudanÃ§as
        token: ${{ secrets.GITHUB_TOKEN }}
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Pull published Docker image
      run: |
        # Pull da imagem publicada
        docker pull axwayjbarros/aws-lambda-apim-sdk:1.0.0
        
    - name: Check if Release is Needed
      id: release_check
      run: |
        echo "ğŸ” Verificando se release Ã© necessÃ¡rio..."
        ./scripts/check-release-needed.sh
        
        if [ -f .release_check ]; then
          source .release_check
          echo "ğŸ“‹ Resultado da anÃ¡lise:"
          echo "   Release necessÃ¡rio: $RELEASE_NEEDED"
          echo "   Arquivos relevantes: $RELEVANT_FILES"
          
          if [ "$RELEASE_NEEDED" = "true" ]; then
            echo "ğŸ”´ Release serÃ¡ criado!"
            echo "version_type=$VERSION_TYPE" >> $GITHUB_OUTPUT
            echo "old_version=$OLD_VERSION" >> $GITHUB_OUTPUT
            echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
            echo "release_needed=true" >> $GITHUB_OUTPUT
          else
            echo "ğŸŸ¢ Nenhum release necessÃ¡rio"
            echo "release_needed=false" >> $GITHUB_OUTPUT
          fi
        else
          echo "âš ï¸  Arquivo .release_check nÃ£o encontrado"
          echo "release_needed=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Build JAR with Docker
      run: |
        echo 'ğŸ³ Executando build com Docker...'
        echo 'ğŸ“¦ Imagem: axwayjbarros/aws-lambda-apim-sdk:1.0.0'
        echo 'ğŸ”§ ParÃ¢metro axway.base: /opt/Axway'
        
        # Executar build dentro do container Docker
        docker run --rm \
          -v "$(pwd):/workspace" \
          -w /workspace \
          axwayjbarros/aws-lambda-apim-sdk:1.0.0 \
          gradle -Daxway.base=/opt/Axway clean build
        
        echo 'ğŸ“‹ Verificando resultado...'
        ls -la build/libs/ || echo 'DiretÃ³rio build/libs nÃ£o encontrado'
        
    - name: Test JAR
      run: |
        # Verificar se o JAR foi criado
        echo "ğŸ” Verificando JAR criado..."
        ls -la build/libs/aws-lambda-apim-sdk-*.jar || echo "âŒ JAR nÃ£o encontrado"
        
        # Verificar conteÃºdo do JAR
        echo "ğŸ“‹ ConteÃºdo do JAR:"
        jar -tf build/libs/aws-lambda-apim-sdk-*.jar | head -10 || echo "âŒ NÃ£o foi possÃ­vel verificar conteÃºdo"
        
        # Verificar tamanho do JAR
        echo "ğŸ“ Tamanho do JAR:"
        du -h build/libs/aws-lambda-apim-sdk-*.jar || echo "âŒ NÃ£o foi possÃ­vel verificar tamanho"
        
        # Verificar se o JAR contÃ©m as classes principais
        echo "ğŸ” Verificando classes principais..."
        jar -tf build/libs/aws-lambda-apim-sdk-*.jar | grep -E "(AWSLambdaFilter|AWSLambdaProcessor)" || echo "âŒ Classes principais nÃ£o encontradas"
        
    - name: Upload JAR as artifact
      uses: actions/upload-artifact@v4
      with:
        name: aws-lambda-apim-sdk-jar
        path: build/libs/aws-lambda-apim-sdk-*.jar
        retention-days: 30
        
    - name: Create Release
      if: steps.release_check.outputs.release_needed == 'true' && github.event_name != 'pull_request' && contains(github.ref, 'master')
      run: |
        echo "ğŸš€ Criando release automaticamente..."
        
        # Configurar git com token
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # Configurar remote com token
        git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
        
        # Obter informaÃ§Ãµes da versÃ£o
        source .release_check
        NEW_VERSION="$NEW_VERSION"
        
        echo "ğŸ“‹ Verificando tag: v$NEW_VERSION"
        
        # Verificar se a tag jÃ¡ existe
        if git tag -l "v$NEW_VERSION" | grep -q "v$NEW_VERSION"; then
          echo "âš ï¸  Tag v$NEW_VERSION jÃ¡ existe. Pulando criaÃ§Ã£o da tag."
        else
          echo "ğŸ“‹ Criando tag: v$NEW_VERSION"
          # Criar tag
          git tag "v$NEW_VERSION"
          # Push da tag
          git push origin "v$NEW_VERSION"
          echo "âœ… Tag v$NEW_VERSION criada e enviada!"
        fi
        
        echo "ğŸ”„ Continuando com criaÃ§Ã£o do release..."
        
    - name: Generate changelog
      if: steps.release_check.outputs.release_needed == 'true' && github.event_name != 'pull_request' && contains(github.ref, 'master')
      id: changelog
      run: |
        source .release_check
        NEW_VERSION="$NEW_VERSION"
        
        echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
        git log --oneline $(git describe --tags --abbrev=0 HEAD^)..HEAD >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: Create GitHub Release
      if: steps.release_check.outputs.release_needed == 'true' && github.event_name != 'pull_request' && contains(github.ref, 'master')
      uses: actions/create-release@v1
      id: create_release
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ steps.release_check.outputs.new_version }}
        release_name: Release v${{ steps.release_check.outputs.new_version }}
        body: |
          ## Changes in this Release
          
          ${{ steps.changelog.outputs.CHANGELOG }}
          
          ## Build Information
          
          This release was built using the Docker image `axwayjbarros/aws-lambda-apim-sdk:1.0.0` which contains:
          - Axway API Gateway 7.7.0.20240830
          - Java 11 OpenJDK
          - AWS SDK for Java 1.12.314
          - All necessary dependencies for building the filter
          
          ## Installation
          
          Download the JAR file from the assets below and follow the installation guide in the README.
          
          ## Usage
          
          This JAR contains the AWS Lambda integration for Axway API Gateway. 
          Follow the installation guide in the README for setup instructions.
        draft: false
        prerelease: false
        
    - name: Upload JAR to Release
      if: steps.release_check.outputs.release_needed == 'true' && github.event_name != 'pull_request' && contains(github.ref, 'master')
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./build/libs/aws-lambda-apim-sdk-*.jar
        asset_name: aws-lambda-apim-sdk-v${{ steps.release_check.outputs.new_version }}.jar
        asset_content_type: application/java-archive
        
    - name: Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          try {
            const jarFiles = fs.readdirSync('build/libs').filter(file => file.endsWith('.jar'));
            const jarFile = jarFiles[0];
            const jarPath = path.join('build/libs', jarFile);
            const stats = fs.statSync(jarPath);
            const sizeInMB = (stats.size / (1024 * 1024)).toFixed(2);
            
            // Ler informaÃ§Ãµes do release se disponÃ­vel
            let releaseInfo = '';
            try {
              const fs = require('fs');
              if (fs.existsSync('.release_check')) {
                const releaseData = fs.readFileSync('.release_check', 'utf8');
                const lines = releaseData.split('\n');
                const releaseMap = {};
                lines.forEach(line => {
                  const [key, value] = line.split('=');
                  if (key && value) releaseMap[key] = value;
                });
                
                if (releaseMap.RELEASE_NEEDED === 'true' && releaseMap.NEW_VERSION) {
                  releaseInfo = `
                  
                  ğŸ”¢ **AnÃ¡lise de Release:**
                  ğŸ“Š **Release necessÃ¡rio:** ${releaseMap.RELEASE_NEEDED}
                  ğŸ“ˆ **Nova versÃ£o:** ${releaseMap.NEW_VERSION}
                  ğŸ“‹ **VersÃ£o anterior:** ${releaseMap.OLD_VERSION}
                  ğŸ” **Tipo:** ${releaseMap.VERSION_TYPE}
                  ğŸ“ **Arquivos relevantes:** ${releaseMap.RELEVANT_FILES}`;
                } else {
                  releaseInfo = `
                  
                  ğŸŸ¢ **AnÃ¡lise de Release:**
                  ğŸ“Š **Release necessÃ¡rio:** ${releaseMap.RELEASE_NEEDED || 'false'}
                  ğŸ“‹ **Motivo:** Nenhuma mudanÃ§a relevante detectada`;
                }
              }
            } catch (e) {
              console.log('NÃ£o foi possÃ­vel ler informaÃ§Ãµes do release:', e.message);
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âœ… Build concluÃ­do com sucesso!
              
              ğŸ“¦ **JAR criado:** ${jarFile}
              ğŸ“ **Tamanho:** ${sizeInMB} MB
              ğŸ³ **Build com:** axwayjbarros/aws-lambda-apim-sdk:1.0.0${releaseInfo}
              
              O JAR estÃ¡ disponÃ­vel como artifact para download.`
            });
          } catch (error) {
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âŒ Build falhou!
              
              Erro: ${error.message}
              
              Verifique os logs para mais detalhes.`
            });
          } 